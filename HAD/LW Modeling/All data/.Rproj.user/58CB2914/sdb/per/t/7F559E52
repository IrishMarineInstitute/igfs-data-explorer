{
    "collab_server" : "",
    "contents" : "library(FSA)\nlibrary(magrittr)\nlibrary(dplyr)\nlibrary(nlstools)\nlibrary(FSAsim)\nlibrary(tidyverse)\nlibrary(broom)\nlibrary(lhmixr)\nlibrary(tidyverse)\nlibrary(RODBC)\n\nchannel <- odbcDriverConnect(\"Driver=SQL Server; Server=VMINFORMDEV01; Database=InformaticsLoad;\")\nLWA<- sqlQuery(channel,\"SELECT * FROM SurveyLenghtWeightAge\")\nclose(channel)\n\n\n\nsetwd(\"H:\\\\IGFS\\\\IGFS3\\\\HAD\\\\LW Modeling\\\\All data\")\n\nLWA_missingremoved=filter(LWA, !is.na(age) & age>=0 & ICESCODE !=\"VIIa\")\n\nvbTyp = function(age, Linf, K, t0) Linf*(1-exp(-K*(age-t0)))\n\ntable(LWA_missingremoved$fldMainSpeciesCode)\n\n\n\n#Choose species\nfish=\"POK\"\nLWA_fish=filter(LWA_missingremoved, fldMainSpeciesCode==fish)# for POK remove age <7\n\n#All data\nsvTyp=vbStarts(length ~ age, data=LWA_fish)\nfitTyp=nls(length ~ vbTyp(age, Linf, K, t0), data=LWA_fish, start=svTyp)\n#create vector with coeff for all data\ncoeff_all=c(coef(fitTyp)[1],coef(fitTyp)[2],coef(fitTyp)[3])\nwrite_rds(coeff_all, paste0(\"Species/\",fish,\"/coeff_all.RDS\"))\n\n#By Year\ndfSample = LWA_fish %>% group_by(Year) %>%\n  do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))\ncoeffs=NULL\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, c(dfSample$Year[[i]], NA, NA, NA))\n  }else{\n    coeffs=rbind(coeffs, cbind(dfSample$Year[[i]],\n                               coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],\n                               coef(dfSample$fitSample[[i]])[[3]]))\n  }\n}\ncoeffs=as.data.frame(coeffs)\ncolnames(coeffs)=c(\"Year\", \"Linf\", \"K\", \"t0\")\ncoeffs\nAllOptions=expand.grid(Year=c(2003:2017))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"Year\"))\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_year.RDS\"))\n\n\n#By Sex\nbinding <- matrix(c(1:2, rep(3, 2), 4:7), ncol = 2, byrow = TRUE)\nrownames(binding) <- c(\"lnlinf\", \"lnk\", \"lnnt0\", \"lnsigma\")\ncolnames(binding) <- c(\"female\", \"male\")\nstart.par <- c(c(log(svTyp[[1]]), log(svTyp[[1]])), rep(log(0.3), 1), rep(log(1), 2), \n               rep(log(.1), 2))\nstart.list <- list(par = list(mixprop = 0.5, growth.par = start.par))\nvb.bind.fit <- vb_growth_mix(data = LWA_fish, start.list = start.list,\n                             binding = binding, distribution = \"lognormal\",\n                             reltol = 1e-6, plot.fit=TRUE, \n                             estimate.mixprop=TRUE)\ncoeff_sex=vb.bind.fit$coefficients\nwrite_rds(coeff_sex, paste0(\"Species/\",fish,\"/coeff_sex.RDS\"))\n\n\n\n#By Sex and by year\nvb.bind.fit<- function(df) {\n  vb_growth_mix(data = df, start.list = start.list, binding = binding, distribution = \"lognormal\", \n                reltol = 1e-6, plot.fit=TRUE, \n                estimate.mixprop=TRUE)\n}\ndfSample = LWA_fish %>% group_by(Year) %>%\n  do(fitSample = try(vb.bind.fit(.)))\ncoeffs=NULL\ncoeffs$Year=as.numeric(as.character(coeffs$Year))\ncoeffs$Female=as.numeric(as.character(coeffs$Female))\ncoeffs$Male=as.numeric(as.character(coeffs$Male))\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, cbind(\"Year\"=rep(dfSample$Year[[i]],5),\n                               \"Parameter\"=c(\"lnlinf\", \"lnk\", \"lnnt0\", \"lnsigma\", \"logitpi\"),\n                               \"Female\"=rep(NA,5),\n                               \"Female.Std.Error\"=rep(NA,5), \"Male\"=rep(NA,5), \n                               \"Male.Std.Error\"=rep(NA,5)))\n  }else{\n    coeffs=rbind(coeffs, cbind(\"Year\"=rep(dfSample$Year[[i]],5),\n                               dfSample$fitSample[[i]]$coefficients))\n  }\n}\ncoeffs$Year=as.numeric(as.character(coeffs$Year))\ncoeffs$Female=as.numeric(as.character(coeffs$Female))\ncoeffs$Male=as.numeric(as.character(coeffs$Male))\ncoeffs$Parameter=as.factor(as.character(coeffs$Parameter))\nAllOptions=expand.grid(Year=c(2003:2017), Parameter=c(\"lnlinf\", \"lnk\", \"lnnt0\", \"lnsigma\", \"logitpi\"))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"Year\", \"Parameter\"))\ncoeffs\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_sex_year.RDS\"))\n\n#By Division\ndfSample = LWA_fish %>% group_by(ICESCODE) %>%\n  do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))\ncoeffs=NULL\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, c(as.character(dfSample$ICESCODE[[i]]), NA, NA, NA))\n  }else{\n    coeffs=rbind(coeffs, cbind(as.character(dfSample$ICESCODE[[i]]),\n                               coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],\n                               coef(dfSample$fitSample[[i]])[[3]]))\n  }\n}\ncoeffs=as.data.frame(coeffs)\ncolnames(coeffs)=c(\"ICESCODE\", \"Linf\", \"K\", \"t0\")\ncoeffs$Linf=as.numeric(as.character(coeffs$Linf))\ncoeffs$K=as.numeric(as.character(coeffs$K))\ncoeffs$t0=as.numeric(as.character(coeffs$t0))\ncoeffs\nAllOptions=expand.grid(ICESCODE=c(\"VIa\", \"VIIb\", \"VIIc\", \"VIIg\", \"VIIj\", \"VIIk\"))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"ICESCODE\"))\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_div.RDS\"))\n\n\n#By Division and year\ndfSample = LWA_fish %>% group_by(ICESCODE, Year) %>%\n  do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))\ncoeffs=NULL\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, c(as.character(dfSample$ICESCODE[[i]]), dfSample$Year[[i]], NA, NA, NA))\n  }else{\n    coeffs=rbind(coeffs, cbind(as.character(dfSample$ICESCODE[[i]]), dfSample$Year[[i]],\n                               coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],\n                               coef(dfSample$fitSample[[i]])[[3]]))\n  }\n}\ncoeffs=as.data.frame(coeffs)\ncolnames(coeffs)=c(\"ICESCODE\", \"Year\", \"Linf\", \"K\", \"t0\")\ncoeffs$Year=as.numeric(as.character(coeffs$Year))\ncoeffs$Linf=as.numeric(as.character(coeffs$Linf))\ncoeffs$K=as.numeric(as.character(coeffs$K))\ncoeffs$t0=as.numeric(as.character(coeffs$t0))\ncoeffs\nAllOptions=expand.grid(Year=c(2003:2017), ICESCODE=c(\"VIa\", \"VIIb\", \"VIIc\", \"VIIg\", \"VIIj\", \"VIIk\"))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"Year\", \"ICESCODE\"))\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_div_year.RDS\"))\n\n\n#By gear\ndfSample = LWA_fish %>% group_by(fldGearDescription) %>%\n  do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))\ncoeffs=NULL\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, c(as.character(dfSample$fldGearDescription[[i]]), NA, NA, NA))\n  }else{\n    coeffs=rbind(coeffs, cbind(as.character(dfSample$fldGearDescription[[i]]),\n                               coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],\n                               coef(dfSample$fitSample[[i]])[[3]]))\n  }\n}\ncoeffs=as.data.frame(coeffs)\ncolnames(coeffs)=c(\"Gear\", \"Linf\", \"K\", \"t0\")\ncoeffs$Linf=as.numeric(as.character(coeffs$Linf))\ncoeffs$K=as.numeric(as.character(coeffs$K))\ncoeffs$t0=as.numeric(as.character(coeffs$t0))\ncoeffs\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_gear.RDS\"))\n\n#By gear by year\ndfSample = LWA_fish %>% group_by(fldGearDescription, Year) %>%\n  do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))\ncoeffs=NULL\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, c(as.character(dfSample$fldGearDescription[[i]]), dfSample$Year[[i]], NA, NA, NA))\n  }else{\n    coeffs=rbind(coeffs, cbind(as.character(dfSample$fldGearDescription[[i]]), dfSample$Year[[i]],\n                               coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],\n                               coef(dfSample$fitSample[[i]])[[3]]))\n  }\n}\ncoeffs=as.data.frame(coeffs)\ncolnames(coeffs)=c(\"Gear\", \"Year\", \"Linf\", \"K\", \"t0\")\ncoeffs$Year=as.numeric(as.character(coeffs$Year))\ncoeffs$Linf=as.numeric(as.character(coeffs$Linf))\ncoeffs$K=as.numeric(as.character(coeffs$K))\ncoeffs$t0=as.numeric(as.character(coeffs$t0))\ncoeffs\nAllOptions=expand.grid(Year=c(2003:2017), Gear=c(\"GOV 3647 Groundgear A\", \"GOV 3647 Groundgear D\"))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"Year\", \"Gear\"))\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_gear_year.RDS\"))\n\n\n##################################################\n##################################################\n# Cohort\n##################################################\n##################################################\n\n#By Year\ndfSample = LWA_fish %>% group_by(Cohort) %>%\n  do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))\nprint(tbl_df(dfSample), n=30)\n\ncoeffs=NULL\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, c(dfSample$Cohort[[i]], NA, NA, NA))\n  }else{\n    coeffs=rbind(coeffs, cbind(dfSample$Cohort[[i]],\n                               coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],\n                               coef(dfSample$fitSample[[i]])[[3]]))\n  }\n}\ncoeffs=as.data.frame(coeffs)\ncolnames(coeffs)=c(\"Cohort\", \"Linf\", \"K\", \"t0\")\ncoeffs=filter(coeffs, Cohort>2002)\nAllOptions=expand.grid(Cohort=c(2003:2017))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"Cohort\"))\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_cohort.RDS\"))\n\n#cohort by division\ndfSample = LWA_fish %>% group_by(ICESCODE, Cohort) %>%\n  do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))\ncoeffs=NULL\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, c(as.character(dfSample$ICESCODE[[i]]), dfSample$Cohort[[i]], NA, NA, NA))\n  }else{\n    coeffs=rbind(coeffs, cbind(as.character(dfSample$ICESCODE[[i]]), dfSample$Cohort[[i]],\n                               coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],\n                               coef(dfSample$fitSample[[i]])[[3]]))\n  }\n}\ncoeffs=as.data.frame(coeffs)\ncolnames(coeffs)=c(\"ICESCODE\", \"Cohort\", \"Linf\", \"K\", \"t0\")\ncoeffs$Cohort=as.numeric(as.character(coeffs$Cohort))\ncoeffs$Linf=as.numeric(as.character(coeffs$Linf))\ncoeffs$K=as.numeric(as.character(coeffs$K))\ncoeffs$t0=as.numeric(as.character(coeffs$t0))\ncoeffs=filter(coeffs, Cohort>2002)\nAllOptions=expand.grid(Cohort=c(2003:2017), ICESCODE=c(\"VIa\", \"VIIb\", \"VIIc\", \"VIIg\", \"VIIj\", \"VIIk\"))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"Cohort\", \"ICESCODE\"))\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_cohort_div.RDS\"))\n\n\n#cohort by gear\ndfSample = LWA_fish %>% group_by(fldGearDescription, Cohort) %>%\n  do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))\ncoeffs=NULL\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, c(as.character(dfSample$fldGearDescription[[i]]), dfSample$Cohort[[i]], NA, NA, NA))\n  }else{\n    coeffs=rbind(coeffs, cbind(as.character(dfSample$fldGearDescription[[i]]), dfSample$Cohort[[i]],\n                               coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],\n                               coef(dfSample$fitSample[[i]])[[3]]))\n  }\n}\ncoeffs=as.data.frame(coeffs)\ncolnames(coeffs)=c(\"Gear\", \"Cohort\", \"Linf\", \"K\", \"t0\")\ncoeffs$Cohort=as.numeric(as.character(coeffs$Cohort))\ncoeffs$Linf=as.numeric(as.character(coeffs$Linf))\ncoeffs$K=as.numeric(as.character(coeffs$K))\ncoeffs$t0=as.numeric(as.character(coeffs$t0))\ncoeffs\ncoeffs=filter(coeffs, Cohort>2002)\nAllOptions=expand.grid(Cohort=c(2003:2017), Gear=c(\"GOV 3647 Groundgear A\", \"GOV 3647 Groundgear D\"))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"Cohort\", \"Gear\"))\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_gear_cohort.RDS\"))\n\n\n#By sex\nbinding <- matrix(c(1:2, rep(3, 2), 4:7), ncol = 2, byrow = TRUE)\nrownames(binding) <- c(\"lnlinf\", \"lnk\", \"lnnt0\", \"lnsigma\")\ncolnames(binding) <- c(\"female\", \"male\")\nstart.par <- c(c(log(svTyp[[1]]), log(svTyp[[1]])), rep(log(0.3), 1), rep(log(1), 2), \n               rep(log(.1), 2))\nstart.list <- list(par = list(mixprop = 0.5, growth.par = start.par))\n\nvb.bind.fit<- function(df) {\n  vb_growth_mix(data = df, start.list = start.list, binding = binding, distribution = \"lognormal\", \n                reltol = 1e-6, plot.fit=TRUE, \n                estimate.mixprop=TRUE)\n}\n\ndfSample = LWA_fish %>% group_by(Cohort) %>%\n  filter(Cohort>2002) %>%\n  do(fitSample = try(vb.bind.fit(.)))\ncoeffs=NULL\ncoeffs$Cohort=as.numeric(as.character(coeffs$Cohort))\ncoeffs$Female=as.numeric(as.character(coeffs$Female))\ncoeffs$Male=as.numeric(as.character(coeffs$Male))\nfor(i in 1:dim(dfSample)[1]){\n  if(substring(dfSample$fitSample[[i]][1],1,5)==\"Error\"){\n    coeffs=rbind(coeffs, cbind(\"Cohort\"=rep(dfSample$Cohort[[i]],5),\n                               \"Parameter\"=c(\"lnlinf\", \"lnk\", \"lnnt0\", \"lnsigma\", \"logitpi\"),\n                               \"Female\"=rep(NA,5),\n                               \"Female.Std.Error\"=rep(NA,5), \"Male\"=rep(NA,5), \n                               \"Male.Std.Error\"=rep(NA,5)))\n  }else{\n    coeffs=rbind(coeffs, cbind(\"Cohort\"=rep(dfSample$Cohort[[i]],5),\n                               dfSample$fitSample[[i]]$coefficients))\n  }\n}\ncoeffs$Cohort=as.numeric(as.character(coeffs$Cohort))\ncoeffs$Female=as.numeric(as.character(coeffs$Female))\ncoeffs$Male=as.numeric(as.character(coeffs$Male))\nAllOptions=expand.grid(Cohort=c(2003:2017), Parameter=c(\"lnlinf\", \"lnk\", \"lnnt0\", \"lnsigma\", \"logitpi\"))\ncoeffs=left_join(AllOptions, coeffs, by=c(\"Cohort\", \"Parameter\"))\n\nwrite_rds(coeffs, paste0(\"Species/\",fish,\"/coeff_sex_cohort.RDS\"))\n\n\n",
    "created" : 1531210092199.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1150802403",
    "id" : "7F559E52",
    "lastKnownWriteTime" : 1531306219,
    "last_content_update" : 1531306219992,
    "path" : "H:/IGFS/IGFS3/HAD/LW Modeling/All data/VBGM coeffs V4.R",
    "project_path" : "VBGM coeffs V4.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}