}
for(i in 1:1){
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
y <- gsub("\\Cod\\b", paste0(FullName[[i]]), x)
writeLines(y,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
y <-  gsub("\\COD\\b", paste0(name[[i]]), x)
writeLines(y,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/ui.R"))
y <-  gsub("\\Cod\\b", paste0(FullName[[i]]), x)
writeLines(y, paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/ui.R"))
}
for(i in 1:length(nam)){
file.copy("H:/test/Exploing IGFS/Species/COD/server.R",paste0("H:/test/Exploing IGFS/Species/",nam[[i]]),overwrite = T)
file.copy("H:/test/Exploing IGFS/Species/COD/ui.R",paste0("H:/test/Exploing IGFS/Species/",nam[[i]]),overwrite = T)
}
for(i in 1:1){
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
y <- gsub("\\Cod\\b", paste0(FullName[[i]]), x)
writeLines(y,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
y <-  gsub("\\COD\\b", paste0(nam[[i]]), x)
writeLines(y,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/ui.R"))
y <-  gsub("\\Cod\\b", paste0(FullName[[i]]), x)
writeLines(y, paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/ui.R"))
}
runApp('H:/test/Exploing IGFS/Species/BOF')
for(i in 1:length(nam)){
file.copy("H:/test/Exploing IGFS/Species/COD/server.R",paste0("H:/test/Exploing IGFS/Species/",nam[[i]]),overwrite = T)
file.copy("H:/test/Exploing IGFS/Species/COD/ui.R",paste0("H:/test/Exploing IGFS/Species/",nam[[i]]),overwrite = T)
}
for(i in 1:length(nam)){
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
y <- gsub("\\Cod\\b", paste0(FullName[[i]]), x)
writeLines(y,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
y <-  gsub("\\COD\\b", paste0(nam[[i]]), x)
writeLines(y,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/ui.R"))
y <-  gsub("\\Cod\\b", paste0(FullName[[i]]), x)
writeLines(y, paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/ui.R"))
}
runApp('H:/test/Exploing IGFS/Species/MON')
runApp('H:/test/Exploing IGFS/Species/POK')
L<-readRDS("H:/test/Exploing IGFS/Species/BOF/LengthWeightAge.RDS"))
L<-readRDS("H:/test/Exploing IGFS/Species/BOF/LengthWeightAge.RDS")
dim(filter(L,is.na(age)==T))
dim(filter(L,is.na(age)==F))
summRy(L)
summry(L)
summary(L)
dim(filter(L,is.na(age)==T))
dim(filter(L,age==NA))
dim(filter(L,age!=NA))
filter(L,age!=NA)
library(dplyr)
filter(L,age!=NA)
dim(filter(L,is.na(age)==T))
dim(filter(L,is.na(age)==F))
is.na(L$age)
is.na(L$age)
L
L<-readRDS("H:/test/Exploing IGFS/Species/BOF/LengthWeightAge.RDS")
L
L<-readRDS("H:/test/Exploing IGFS/Species/BOF/LengthWeightAge.RDS")
summary(L)
summary(L$age)
L$age
L$age==0
L<-readRDS("H:/test/Exploing IGFS/Species/CUR/LengthWeightAge.RDS")
L$age
dim(filter(L,age==NA))[1]
L<-readRDS("H:/test/Exploing IGFS/Species/HAD/LengthWeightAge.RDS")
dim(filter(L,age==NA))[1]
dim(filter(L,age!=NA))[1]
L<-readRDS("H:/test/Exploing IGFS/Species/HAD/LengthWeightAge.RDS")
summary(L)
dim(filter(L,age==NA))[1]
dim(filter(L,age!=NA))
summary(filter(L,age!=NA))
L
summary(L)
L1<-filter(L,age!=NA)
summary(L1)
L1<-filter(L,age!="NA")
summary(L1)
L1<-filter(L,age!="NA")
L1<-filter(L,age!="NA")
summary(L1)
summary(L1)
dim(L1)
dim(L1)[1]
L<-readRDS("H:/test/Exploing IGFS/Species/BOF/LengthWeightAge.RDS")
L1<-filter(L,age!="NA")
dim(L1)[1]
dim(filter(L,age!="NA"))
L<-readRDS("H:/test/Exploing IGFS/Species/HAD/LengthWeightAge.RDS")
dim(filter(L,age!="NA"))
dim(filter(L,age!="NA"))[1]
L<-readRDS("H:/test/Exploing IGFS/Species/bof/LengthWeightAge.RDS")
dim(filter(L,age!="NA"))[1]
shiny::runApp('H:/test/Exploing IGFS/Species/HAD')
runApp('H:/test/Exploing IGFS/Species/HAD')
for(i in 1:length(nam)){
file.copy("H:/test/Exploing IGFS/Species/HAD/server.R",paste0("H:/test/Exploing IGFS/Species/",nam[[i]]),overwrite = T)
# file.copy("H:/test/Exploing IGFS/Species/COD/ui.R",paste0("H:/test/Exploing IGFS/Species/",nam[[i]]),overwrite = T)
}
nam<-c("BOF","COD","CUR","DAB","DGS","ESB","GUG","HER","HKE","HOM","JOD","LSD","MAC",
"MEG","MON","NOP","PLE","POD","POK","POL","SDR","SKT","SOL","SPR","THR","WAF","WHB","WHG")
FullName<-c("Boarfish","Cod","Cuckoo Ray","Dab","Spurdog","Seabass","Grey Gurnard","Herring","Hake","Horse Mackerel",
"John Dory","Lesser Spotted Dogfish","Mackerel","Megrim","Monkfish","Norway Pout","Place","Poor Cod",
"Saithe","Pollack","Spotted Ray","Common Skate","Sole",
"Sprat","Thornback Ray","Black Bellied Monkfish","Blue Whiting","Whiting")
for(i in 1:length(nam)){
file.copy("H:/test/Exploing IGFS/Species/HAD/server.R",paste0("H:/test/Exploing IGFS/Species/",nam[[i]]),overwrite = T)
# file.copy("H:/test/Exploing IGFS/Species/COD/ui.R",paste0("H:/test/Exploing IGFS/Species/",nam[[i]]),overwrite = T)
}
for(i in 1:length(nam)){
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
y <- gsub("\\Cod\\b", paste0(FullName[[i]]), x)
writeLines(y,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
y <-  gsub("\\COD\\b", paste0(nam[[i]]), x)
writeLines(y,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/server.R"))
#x <- readLines(paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/ui.R"))
#y <-  gsub("\\Cod\\b", paste0(FullName[[i]]), x)
#writeLines(y, paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/ui.R"))
}
runApp('H:/test/Exploing IGFS/Species/COD')
shiny::runApp('H:/test/Test2/tables')
runApp('H:/test/Test2/tables')
install.packages("DT")
runApp('H:/test/Test2/tables')
runApp('H:/test/Test2/tables')
runApp('H:/test/Test2/tables')
runApp('H:/test/Test2/tables')
runApp('H:/test/Test2/tables')
runApp('H:/test/Test2/tables')
runApp('H:/test/Test2/tables')
runApp('H:/test/Test2/tables')
runApp('H:/test/Exploing IGFS/Species/HAD')
runApp('H:/test/Exploing IGFS/Species/COD')
runApp('H:/test/Exploing IGFS/IGFS for Deployment/COD')
library("tidyverse", lib.loc="~/R/win-library/3.5")
runApp('L:/InformaticsProject/Phase1/IGFS Use case/Species Specific Code/COD')
install.packages("colorspace")
install.packages("colorspace")
shiny::runApp('L:/InformaticsProject/Phase1/IGFS Use case/Species Specific Code/COD')
shiny::runApp('H:/test/Exploing IGFS/Species/PLE')
runApp('H:/test/Exploing IGFS/Species/COD')
runApp('H:/test/Exploing IGFS/Species/HAD')
lw<-readRDS('H:/test/Exploing IGFS/Species/COD/LengthWeightAge.RDS')
summary(lw)
lw<-readRDS('H:/test/Exploing IGFS/Species/HAD/LengthWeightAge.RDS')
summary(lw)
lw<-readRDS('H:/test/Exploing IGFS/All Data/LengthWeightAge.RDS')
nam<-c("COD","MEG","PLE")
for(i in 1:length(nam)){
#test<-filter(FdU,Species==nam[[i]])
#saveRDS(test,paste0("H:/test/Exploing IGFS/IGFS Updates/",nam[[i]],"/dat.RDS"))
#test<-filter(Fd1U,Species==nam[[i]])
#saveRDS(test,paste0("H:/test/Exploing IGFS/IGFS Updates/",nam[[i]],"/data1.RDS"))
#test<-filter(FlU,Species==nam[[i]])
#saveRDS(test,paste0("H:/test/Exploing IGFS/IGFS Updates/",nam[[i]],"/LengthData.RDS"))
test<-filter(lw,fldMainSpeciesCode ==nam[[i]])
saveRDS(test,paste0("H:/test/Exploing IGFS/Species/",nam[[i]],"/LengthWeightAge.RDS"))}
runApp('H:/test/Exploing IGFS/Species/COD')
runApp('H:/test/Exploing IGFS/Species/PLE')
runApp('H:/test/Exploing IGFS/Species/MEG')
runApp('H:/test/Exploing IGFS/Species/PLE')
library(FSA)
library(magrittr)
library(dplyr)
library(nlstools)
library(FSAsim)
library(tidyverse)
library(broom)
library(lhmixr)
library(tidyverse)
library(RODBC)
setwd("H:\\test\\Exploing IGFS")
vbTyp = function(age, Linf, K, t0) Linf*(1-exp(-K*(age-t0)))
#nam<-c("COD" ,"DGS","HAD" ,"HER", "HOM", "MAC", "MEG", "MON" ,"PLE", "POL",
#"SOL", "WAF", "WHB"  ,"WHG")
#Choose species
fish="PLE"
LWA<-readRDS(paste0("Species/",fish,"/LengthWeightAge.RDS"))
levels(LWA$obs.sex)<-c("female","male","unclassified")
LWA_missingremoved<-LWA[-which(is.na(LWA$age)),]
summary(LWA_missingremoved)
LWA_fish<-filter(LWA_missingremoved,ICESCODE !="VIIa")
#LWA_fish=filter(LWA_missingremoved, fldMainSpeciesCode==fish)# for POK remove age <7
#All data
svTyp=vbStarts(length ~ age, data=LWA_fish)
fitTyp=nls(length ~ vbTyp(age, Linf, K, t0), data=LWA_fish, start=svTyp)
#create vector with coeff for all data
coeff_all=c(coef(fitTyp)[1],coef(fitTyp)[2],coef(fitTyp)[3])
write_rds(coeff_all, paste0("Species/",fish,"/coeffs/coeff_all.RDS"))
#By Year
dfSample = LWA_fish %>% group_by(Year) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(dfSample$Year[[i]], NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(dfSample$Year[[i]],
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
coeffs=as.data.frame(coeffs)
colnames(coeffs)=c("Year", "Linf", "K", "t0")
coeffs
AllOptions=expand.grid(Year=c(2003:2018))
coeffs=left_join(AllOptions, coeffs, by=c("Year"))
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_year.RDS"))
#By Sex
binding <- matrix(c(1:2, rep(3, 2), 4:7), ncol = 2, byrow = TRUE)
rownames(binding) <- c("lnlinf", "lnk", "lnnt0", "lnsigma")
colnames(binding) <- c("female", "male")
start.par <- c(c(log(svTyp[[1]]), log(svTyp[[1]])), rep(log(0.3), 1), rep(log(1), 2),
rep(log(.1), 2))
start.list <- list(par = list(mixprop = 0.5, growth.par = start.par))
vb.bind.fit <- vb_growth_mix(data = LWA_fish, start.list = start.list,
binding = binding, distribution = "lognormal",
reltol = 1e-6, plot.fit=TRUE,
estimate.mixprop=TRUE)
coeff_sex=vb.bind.fit$coefficients
coeff_sex
write_rds(coeff_sex, paste0("Species/",fish,"/coeffs/coeff_sex.RDS"))
#By Sex and by year
vb.bind.fit<- function(df) {
vb_growth_mix(data = df, start.list = start.list, binding = binding, distribution = "lognormal",
reltol = 1e-6, plot.fit=TRUE,
estimate.mixprop=TRUE)
}
dfSample = LWA_fish %>% group_by(Year) %>%
do(fitSample = try(vb.bind.fit(.)))
coeffs=NULL
coeffs$Year=as.numeric(as.character(coeffs$Year))
coeffs$Female=as.numeric(as.character(coeffs$Female))
coeffs$Male=as.numeric(as.character(coeffs$Male))
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, cbind("Year"=rep(dfSample$Year[[i]],5),
"Parameter"=c("lnlinf", "lnk", "lnnt0", "lnsigma", "logitpi"),
"Female"=rep(NA,5),
"Female.Std.Error"=rep(NA,5), "Male"=rep(NA,5),
"Male.Std.Error"=rep(NA,5)))
}else{
coeffs=rbind(coeffs, cbind("Year"=rep(dfSample$Year[[i]],5),
dfSample$fitSample[[i]]$coefficients))
}
}
coeffs$Year=as.numeric(as.character(coeffs$Year))
coeffs$Female=as.numeric(as.character(coeffs$Female))
coeffs$Male=as.numeric(as.character(coeffs$Male))
coeffs$Parameter=as.factor(as.character(coeffs$Parameter))
AllOptions=expand.grid(Year=c(2003:2018), Parameter=c("lnlinf", "lnk", "lnnt0", "lnsigma", "logitpi"))
coeffs=left_join(AllOptions, coeffs, by=c("Year", "Parameter"))
coeffs
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_sex_year.RDS"))
#By Division
dfSample = LWA_fish %>% group_by(ICESCODE) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(as.character(dfSample$ICESCODE[[i]]), NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(as.character(dfSample$ICESCODE[[i]]),
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
coeffs=as.data.frame(coeffs)
colnames(coeffs)=c("ICESCODE", "Linf", "K", "t0")
coeffs$Linf=as.numeric(as.character(coeffs$Linf))
coeffs$K=as.numeric(as.character(coeffs$K))
coeffs$t0=as.numeric(as.character(coeffs$t0))
coeffs
AllOptions=expand.grid(ICESCODE=c("VIa", "VIIb", "VIIc", "VIIg", "VIIj", "VIIk"))
coeffs=left_join(AllOptions, coeffs, by=c("ICESCODE"))
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_div.RDS"))
#By Division and year
dfSample = LWA_fish %>% group_by(ICESCODE, Year) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(as.character(dfSample$ICESCODE[[i]]), dfSample$Year[[i]], NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(as.character(dfSample$ICESCODE[[i]]), dfSample$Year[[i]],
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
coeffs=as.data.frame(coeffs)
colnames(coeffs)=c("ICESCODE", "Year", "Linf", "K", "t0")
coeffs$Year=as.numeric(as.character(coeffs$Year))
coeffs$Linf=as.numeric(as.character(coeffs$Linf))
coeffs$K=as.numeric(as.character(coeffs$K))
coeffs$t0=as.numeric(as.character(coeffs$t0))
coeffs
AllOptions=expand.grid(Year=c(2003:2018), ICESCODE=c("VIa", "VIIb", "VIIc", "VIIg", "VIIj", "VIIk"))
coeffs=left_join(AllOptions, coeffs, by=c("Year", "ICESCODE"))
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_div_year.RDS"))
#By gear
dfSample = LWA_fish %>% group_by(fldGearDescription) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(as.character(dfSample$fldGearDescription[[i]]), NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(as.character(dfSample$fldGearDescription[[i]]),
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
colnames(coeffs)=c("Gear", "Linf", "K", "t0")
coeffs=as.data.frame(coeffs)
coeffs$Linf=as.numeric(as.character(coeffs$Linf))
coeffs$K=as.numeric(as.character(coeffs$K))
coeffs$t0=as.numeric(as.character(coeffs$t0))
coeffs
#levels(coeffs$Gear)<-c("GOV 3647 Groundgear A", "GOV 3647 Groundgear D")
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_gear.RDS"))
#By gear by year
dfSample = LWA_fish %>% group_by(fldGearDescription, Year) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(as.character(dfSample$fldGearDescription[[i]]), dfSample$Year[[i]], NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(as.character(dfSample$fldGearDescription[[i]]), dfSample$Year[[i]],
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
coeffs=as.data.frame(coeffs)
colnames(coeffs)=c("Gear", "Year", "Linf", "K", "t0")
coeffs$Year=as.numeric(as.character(coeffs$Year))
coeffs$Linf=as.numeric(as.character(coeffs$Linf))
coeffs$K=as.numeric(as.character(coeffs$K))
coeffs$t0=as.numeric(as.character(coeffs$t0))
coeffs
AllOptions=expand.grid(Year=c(2003:2018), Gear=c("GOV 3647 Groundgear A", "GOV 3647 Groundgear D"))
coeffs=left_join(AllOptions, coeffs, by=c("Year", "Gear"))
#levels(coeffs$Gear)<-c("GOV 3647 Groundgear A", "GOV 3647 Groundgear D")
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_gear_year.RDS"))
##########################################
# for Area via and vii
#By area
dfSample = LWA_fish %>% group_by(AreaByICESCODE) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(as.character(dfSample$AreaByICESCODE[[i]]), NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(as.character(dfSample$AreaByICESCODE[[i]]),
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
colnames(coeffs)=c("Area", "Linf", "K", "t0")
coeffs=as.data.frame(coeffs)
coeffs$Linf=as.numeric(as.character(coeffs$Linf))
coeffs$K=as.numeric(as.character(coeffs$K))
coeffs$t0=as.numeric(as.character(coeffs$t0))
coeffs
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_area.RDS"))
#By area by year
dfSample = LWA_fish %>% group_by(AreaByICESCODE, Year) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(as.character(dfSample$AreaByICESCODE[[i]]), dfSample$Year[[i]], NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(as.character(dfSample$AreaByICESCODE[[i]]), dfSample$Year[[i]],
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
coeffs=as.data.frame(coeffs)
colnames(coeffs)=c("Area", "Year", "Linf", "K", "t0")
coeffs$Year=as.numeric(as.character(coeffs$Year))
coeffs$Linf=as.numeric(as.character(coeffs$Linf))
coeffs$K=as.numeric(as.character(coeffs$K))
coeffs$t0=as.numeric(as.character(coeffs$t0))
coeffs
AllOptions=expand.grid(Year=c(2003:2018), Area=c("VI", "VII"))
coeffs=left_join(AllOptions, coeffs, by=c("Year", "Area"))
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_area_year.RDS"))
##################################################
##################################################
# Cohort
##################################################
##################################################
#By Year
dfSample = LWA_fish %>% group_by(Cohort) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
print(tbl_df(dfSample), n=30)
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(dfSample$Cohort[[i]], NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(dfSample$Cohort[[i]],
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
coeffs=as.data.frame(coeffs)
colnames(coeffs)=c("Cohort", "Linf", "K", "t0")
coeffs=filter(coeffs, Cohort>2002)
AllOptions=expand.grid(Cohort=c(2003:2018))
coeffs=left_join(AllOptions, coeffs, by=c("Cohort"))
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_cohort.RDS"))
#cohort by division
dfSample = LWA_fish %>% group_by(ICESCODE, Cohort) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(as.character(dfSample$ICESCODE[[i]]), dfSample$Cohort[[i]], NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(as.character(dfSample$ICESCODE[[i]]), dfSample$Cohort[[i]],
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
coeffs=as.data.frame(coeffs)
colnames(coeffs)=c("ICESCODE", "Cohort", "Linf", "K", "t0")
coeffs$Cohort=as.numeric(as.character(coeffs$Cohort))
coeffs$Linf=as.numeric(as.character(coeffs$Linf))
coeffs$K=as.numeric(as.character(coeffs$K))
coeffs$t0=as.numeric(as.character(coeffs$t0))
coeffs=filter(coeffs, Cohort>2002)
AllOptions=expand.grid(Cohort=c(2003:2018), ICESCODE=c("VIa", "VIIb", "VIIc", "VIIg", "VIIj", "VIIk"))
coeffs=left_join(AllOptions, coeffs, by=c("Cohort", "ICESCODE"))
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_cohort_div.RDS"))
#cohort by gear
dfSample = LWA_fish %>% group_by(fldGearDescription, Cohort) %>%
do(fitSample = try(nls(length ~ vbTyp(age, Linf, K, t0), data=., start=svTyp)))
coeffs=NULL
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, c(as.character(dfSample$fldGearDescription[[i]]), dfSample$Cohort[[i]], NA, NA, NA))
}else{
coeffs=rbind(coeffs, cbind(as.character(dfSample$fldGearDescription[[i]]), dfSample$Cohort[[i]],
coef(dfSample$fitSample[[i]])[[1]], coef(dfSample$fitSample[[i]])[[2]],
coef(dfSample$fitSample[[i]])[[3]]))
}
}
coeffs=as.data.frame(coeffs)
colnames(coeffs)=c("Gear", "Cohort", "Linf", "K", "t0")
coeffs$Cohort=as.numeric(as.character(coeffs$Cohort))
coeffs$Linf=as.numeric(as.character(coeffs$Linf))
coeffs$K=as.numeric(as.character(coeffs$K))
coeffs$t0=as.numeric(as.character(coeffs$t0))
coeffs
coeffs=filter(coeffs, Cohort>2002)
AllOptions=expand.grid(Cohort=c(2003:2018), Gear=c("GOV 3647 Groundgear A", "GOV 3647 Groundgear D"))
coeffs=left_join(AllOptions, coeffs, by=c("Cohort", "Gear"))
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_gear_cohort.RDS"))
#By sex
binding <- matrix(c(1:2, rep(3, 2), 4:7), ncol = 2, byrow = TRUE)
rownames(binding) <- c("lnlinf", "lnk", "lnnt0", "lnsigma")
colnames(binding) <- c("female", "male")
start.par <- c(c(log(svTyp[[1]]), log(svTyp[[1]])), rep(log(0.3), 1), rep(log(1), 2),
rep(log(.1), 2))
start.list <- list(par = list(mixprop = 0.5, growth.par = start.par))
vb.bind.fit<- function(df) {
vb_growth_mix(data = df, start.list = start.list, binding = binding, distribution = "lognormal",
reltol = 1e-6, plot.fit=TRUE,
estimate.mixprop=TRUE)
}
dfSample = LWA_fish %>% group_by(Cohort) %>%
filter(Cohort>2002) %>%
do(fitSample = try(vb.bind.fit(.)))
coeffs=NULL
coeffs$Cohort=as.numeric(as.character(coeffs$Cohort))
coeffs$Female=as.numeric(as.character(coeffs$Female))
coeffs$Male=as.numeric(as.character(coeffs$Male))
for(i in 1:dim(dfSample)[1]){
if(substring(dfSample$fitSample[[i]][1],1,5)=="Error"){
coeffs=rbind(coeffs, cbind("Cohort"=rep(dfSample$Cohort[[i]],5),
"Parameter"=c("lnlinf", "lnk", "lnnt0", "lnsigma", "logitpi"),
"Female"=rep(NA,5),
"Female.Std.Error"=rep(NA,5), "Male"=rep(NA,5),
"Male.Std.Error"=rep(NA,5)))
}else{
coeffs=rbind(coeffs, cbind("Cohort"=rep(dfSample$Cohort[[i]],5),
dfSample$fitSample[[i]]$coefficients))
}
}
coeffs$Cohort=as.numeric(as.character(coeffs$Cohort))
coeffs$Female=as.numeric(as.character(coeffs$Female))
coeffs$Male=as.numeric(as.character(coeffs$Male))
AllOptions=expand.grid(Cohort=c(2003:2018), Parameter=c("lnlinf", "lnk", "lnnt0", "lnsigma", "logitpi"))
coeffs=left_join(AllOptions, coeffs, by=c("Cohort", "Parameter"))
write_rds(coeffs, paste0("Species/",fish,"/coeffs/coeff_sex_cohort.RDS"))
runApp('Species/PLE')
runApp('Species/MEG')
runApp('Species/MEG')
runApp('Species/MEG')
